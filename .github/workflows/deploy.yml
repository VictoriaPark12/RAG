name: Deploy to EC2

on:
  push:
    branches:
      - main  # main Î∏åÎûúÏπòÏóê pushÎê† ÎïåÎßàÎã§ Î∞∞Ìè¨
  workflow_dispatch:  # ÏàòÎèô Ìä∏Î¶¨Í±∞ Í∞ÄÎä•
    inputs:
      git_ref:
        description: "Git branch/tag/commit to deploy (manual only)"
        required: false
        default: "main"
        type: string
      skip_tests:
        description: "Skip tests (manual only)"
        required: false
        default: "false"
        type: choice
        options:
          - "false"
          - "true"

# Docker ÏóÜÏù¥ ÏßÅÏ†ë Î∞∞Ìè¨

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    if: >
      github.event_name != 'workflow_dispatch' ||
      github.event.inputs.skip_tests != 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.git_ref || 'main' }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r app/requirements.txt
          pip install pytest pytest-cov

      - name: Run unit tests
        run: |
          cd app
          pytest tests/unit_tests -v --cov=. --cov-report=term-missing || echo "No tests found, skipping..."

  deploy:
    name: Deploy to EC2
    needs: test  # ÌÖåÏä§Ìä∏ ÌÜµÍ≥º ÌõÑÏóêÎßå Î∞∞Ìè¨
    runs-on: ubuntu-latest
    if: >
      (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.git_ref || 'main' }}

      - name: Configure SSH
        env:
          SSH_PRIVATE_KEY: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
        run: |
          # ÌôòÍ≤Ω Î≥ÄÏàò Í≤ÄÏ¶ù
          if [ -z "$SSH_PRIVATE_KEY" ]; then
            echo "‚ùå ERROR: EC2_SSH_PRIVATE_KEY secret is not set"
            exit 1
          fi
          if [ -z "$EC2_HOST" ]; then
            echo "‚ùå ERROR: EC2_HOST secret is not set"
            exit 1
          fi
          if [ -z "$EC2_USER" ]; then
            echo "‚ùå ERROR: EC2_USER secret is not set"
            exit 1
          fi

          echo "üîß Configuring SSH..."
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh

          # SSH ÌÇ§ Ï†ÄÏû• (Í∞úÌñâ Î¨∏Ïûê Î≥¥Ï°¥)
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

          # EC2_HOST Í∞í ÌôïÏù∏ Î∞è Í≤ÄÏ¶ù
          echo "üîç EC2_HOST Í∞í ÌôïÏù∏: ${EC2_HOST:0:20}..."  # Ï≤òÏùå 20ÏûêÎßå Ï∂úÎ†• (Î≥¥Ïïà)
          if [ -z "$EC2_HOST" ]; then
            echo "‚ùå ERROR: EC2_HOST Í∞íÏù¥ ÎπÑÏñ¥ÏûàÏäµÎãàÎã§"
            exit 1
          fi

          # known_hostsÏóê Ìò∏Ïä§Ìä∏ Ï∂îÍ∞Ä
          echo "üîß Adding host to known_hosts..."
          ssh-keyscan -H "$EC2_HOST" >> ~/.ssh/known_hosts 2>&1 || {
            echo "‚ö†Ô∏è  Warning: ssh-keyscan failed, but continuing..."
          }

          # SSH Ïó∞Í≤∞ ÌÖåÏä§Ìä∏
          echo "üîç Testing SSH connection..."
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -o ConnectTimeout=10 "$EC2_USER@$EC2_HOST" "echo 'SSH connection successful'" || {
            echo "‚ùå ERROR: SSH connection test failed"
            exit 1
          }

      - name: Deploy to EC2
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}  # Ïòà: /opt/langchain
        run: |
          # DEPLOY_PATH Í≤ÄÏ¶ù
          if [ -z "$DEPLOY_PATH" ]; then
            echo "‚ùå ERROR: DEPLOY_PATH secret is not set"
            exit 1
          fi

          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no "$EC2_USER@$EC2_HOST" bash -s << ENDSSH
            set -e

            DEPLOY_PATH="$DEPLOY_PATH"
            echo "üöÄ Starting deployment to: \$DEPLOY_PATH"

            # Î∞∞Ìè¨ ÎîîÎ†âÌÜ†Î¶¨ ÌôïÏù∏ Î∞è Ïù¥Îèô
            if [ ! -d "\$DEPLOY_PATH" ]; then
              echo "‚ùå ERROR: Deploy path does not exist: \$DEPLOY_PATH"
              exit 1
            fi
            cd "\$DEPLOY_PATH"
            echo "üìÇ Current directory: \$(pwd)"

            # Í∏∞Ï°¥ Î≥ÄÍ≤ΩÏÇ¨Ìï≠ Î∞±ÏóÖ (ÌòπÏãú Î™®Î•º Í≤ΩÏö∞)
            git stash || true

            # ÏµúÏã† ÏΩîÎìú pull (push: main, manual: ÏûÖÎ†• ref)
            REF="${{ github.event.inputs.git_ref }}"
            if [ -z "$REF" ]; then REF="main"; fi
            git fetch --all --tags
            git checkout "$REF"
            git pull origin "$REF" || true

            # .env ÌååÏùº Ï°¥Ïû¨ ÌôïÏù∏ (ÏóÜÏúºÎ©¥ ÏóêÎü¨)
            if [ ! -f .env ]; then
              echo "‚ùå ERROR: .env file not found!"
              exit 1
            fi

            # Python Í∞ÄÏÉÅÌôòÍ≤Ω ÌôïÏù∏ Î∞è ÏÉùÏÑ±
            if [ ! -d venv ]; then
              echo "üì¶ Creating Python virtual environment..."
              python3.11 -m venv venv
            fi

            # Í∞ÄÏÉÅÌôòÍ≤Ω ÌôúÏÑ±Ìôî Î∞è ÏùòÏ°¥ÏÑ± ÏÑ§Ïπò
            echo "üì¶ Installing dependencies..."
            source venv/bin/activate
            pip install --upgrade pip
            pip install -r app/requirements.txt

            # systemd ÏÑúÎπÑÏä§ Ïû¨ÏãúÏûë
            echo "üîÑ Restarting langchain-backend service..."
            sudo systemctl daemon-reload
            sudo systemctl restart langchain-backend

            # Ìó¨Ïä§Ï≤¥ÌÅ¨ ÎåÄÍ∏∞
            echo "‚è≥ Waiting for service to be healthy..."
            sleep 10

            # Î∞±ÏóîÎìú ÏÉÅÌÉú ÌôïÏù∏
            if sudo systemctl is-active --quiet langchain-backend; then
              echo "‚úÖ Backend service is running"
              sudo journalctl -u langchain-backend --no-pager -n 50
            else
              echo "‚ùå Backend service failed to start"
              sudo journalctl -u langchain-backend --no-pager -n 100
              exit 1
            fi

            # API Ìó¨Ïä§Ï≤¥ÌÅ¨
            for i in {1..30}; do
              if curl -f http://localhost:8000/docs > /dev/null 2>&1; then
                echo "‚úÖ API is healthy!"
                break
              fi
              echo "‚è≥ Waiting for API... ($i/30)"
              sleep 2
            done

            echo "üéâ Deployment completed successfully!"
          ENDSSH

      - name: Notify deployment status
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "‚úÖ Deployment succeeded"
          else
            echo "‚ùå Deployment failed"
          fi

      - name: Cleanup SSH key
        if: always()
        run: rm -f ~/.ssh/deploy_key


name: Deploy to EC2

on:
  push:
    branches:
      - main  # main Î∏åÎûúÏπòÏóê pushÎê† ÎïåÎßàÎã§ Î∞∞Ìè¨
  workflow_dispatch:  # ÏàòÎèô Ìä∏Î¶¨Í±∞ Í∞ÄÎä•
    inputs:
      git_ref:
        description: "Git branch/tag/commit to deploy (manual only)"
        required: false
        default: "main"
        type: string
      skip_tests:
        description: "Skip tests (manual only)"
        required: false
        default: "false"
        type: choice
        options:
          - "false"
          - "true"

env:
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    if: >
      github.event_name != 'workflow_dispatch' ||
      github.event.inputs.skip_tests != 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.git_ref || 'main' }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r app/requirements_rag.txt
          pip install pytest pytest-cov

      - name: Run unit tests
        run: |
          cd app
          pytest tests/unit_tests -v --cov=. --cov-report=term-missing || echo "No tests found, skipping..."

  deploy:
    name: Deploy to EC2
    needs: test  # ÌÖåÏä§Ìä∏ ÌÜµÍ≥º ÌõÑÏóêÎßå Î∞∞Ìè¨
    runs-on: ubuntu-latest
    if: >
      (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.git_ref || 'main' }}

      - name: Configure SSH
        env:
          SSH_PRIVATE_KEY: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H $EC2_HOST >> ~/.ssh/known_hosts

      - name: Deploy to EC2
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}  # Ïòà: /opt/langchain
        run: |
          ssh -i ~/.ssh/deploy_key $EC2_USER@$EC2_HOST << 'ENDSSH'
            set -e

            echo "üöÄ Starting deployment..."

            # Î∞∞Ìè¨ ÎîîÎ†âÌÜ†Î¶¨Î°ú Ïù¥Îèô
            cd ${{ secrets.DEPLOY_PATH }}

            # Í∏∞Ï°¥ Î≥ÄÍ≤ΩÏÇ¨Ìï≠ Î∞±ÏóÖ (ÌòπÏãú Î™®Î•º Í≤ΩÏö∞)
            git stash || true

            # ÏµúÏã† ÏΩîÎìú pull (push: main, manual: ÏûÖÎ†• ref)
            REF="${{ github.event.inputs.git_ref }}"
            if [ -z "$REF" ]; then REF="main"; fi
            git fetch --all --tags
            git checkout "$REF"
            git pull origin "$REF" || true

            # .env ÌååÏùº Ï°¥Ïû¨ ÌôïÏù∏ (ÏóÜÏúºÎ©¥ ÏóêÎü¨)
            if [ ! -f .env ]; then
              echo "‚ùå ERROR: .env file not found!"
              exit 1
            fi

            # Docker Ïù¥ÎØ∏ÏßÄ ÎπåÎìú Î∞è Ïª®ÌÖåÏù¥ÎÑà Ïû¨ÏãúÏûë
            echo "üì¶ Building Docker images..."
            docker-compose build --no-cache backend

            echo "üîÑ Restarting services..."
            docker-compose down
            docker-compose up -d

            # Ìó¨Ïä§Ï≤¥ÌÅ¨ ÎåÄÍ∏∞
            echo "‚è≥ Waiting for services to be healthy..."
            sleep 10

            # Î∞±ÏóîÎìú ÏÉÅÌÉú ÌôïÏù∏
            if docker ps | grep -q langchain-backend; then
              echo "‚úÖ Backend is running"
              docker logs --tail 50 langchain-backend
            else
              echo "‚ùå Backend failed to start"
              docker logs --tail 100 langchain-backend
              exit 1
            fi

            # API Ìó¨Ïä§Ï≤¥ÌÅ¨
            for i in {1..30}; do
              if curl -f http://localhost:8000/docs > /dev/null 2>&1; then
                echo "‚úÖ API is healthy!"
                break
              fi
              echo "‚è≥ Waiting for API... ($i/30)"
              sleep 2
            done

            echo "üéâ Deployment completed successfully!"
          ENDSSH

      - name: Notify deployment status
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "‚úÖ Deployment succeeded"
          else
            echo "‚ùå Deployment failed"
          fi

      - name: Cleanup SSH key
        if: always()
        run: rm -f ~/.ssh/deploy_key


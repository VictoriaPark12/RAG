name: Deploy to EC2

on:
  push:
    branches:
      - main  # main ë¸Œëœì¹˜ì— pushë  ë•Œë§ˆë‹¤ ë°°í¬
  workflow_dispatch:  # ìˆ˜ë™ íŠ¸ë¦¬ê±° ê°€ëŠ¥
    inputs:
      git_ref:
        description: "Git branch/tag/commit to deploy (manual only)"
        required: false
        default: "main"
        type: string
      skip_tests:
        description: "Skip tests (manual only)"
        required: false
        default: "false"
        type: choice
        options:
          - "false"
          - "true"

# Docker ì—†ì´ ì§ì ‘ ë°°í¬

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    if: >
      github.event_name != 'workflow_dispatch' ||
      github.event.inputs.skip_tests != 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.git_ref || 'main' }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          # OpenAI ê´€ë ¨ ì˜ì¡´ì„±ë§Œ ì„¤ì¹˜
          pip install langchain-openai>=0.0.5
          pip install python-dotenv>=1.0.0
          pip install fastapi>=0.104.0
          pip install uvicorn[standard]>=0.24.0
          pip install pytest pytest-cov
          echo "âœ… Dependencies installed for OpenAI integration"

      - name: Verify openai folder structure
        run: |
          echo "ğŸ” Verifying openai folder structure..."
          if [ -d "openai" ]; then
            echo "âœ… openai folder exists"
            if [ -f "openai/app/core/llm/openai.py" ]; then
              echo "âœ… openai.py file found"
            else
              echo "âŒ openai.py file not found"
              exit 1
            fi
          else
            echo "âŒ openai folder not found"
            exit 1
          fi

  deploy:
    name: Deploy to EC2
    needs: test  # í…ŒìŠ¤íŠ¸ í†µê³¼ í›„ì—ë§Œ ë°°í¬
    runs-on: ubuntu-latest
    if: >
      (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.git_ref || 'main' }}

      - name: Configure SSH
        env:
          SSH_PRIVATE_KEY: ${{ secrets.EC2_SSH_KEY }}
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
        run: |
          # í™˜ê²½ ë³€ìˆ˜ ê²€ì¦
          if [ -z "$SSH_PRIVATE_KEY" ]; then
            echo "âŒ ERROR: EC2_SSH_KEY secret is not set"
            exit 1
          fi
          if [ -z "$EC2_HOST" ]; then
            echo "âŒ ERROR: EC2_HOST secret is not set"
            exit 1
          fi
          if [ -z "$EC2_USER" ]; then
            echo "âŒ ERROR: EC2_USER secret is not set"
            exit 1
          fi

          echo "ğŸ”§ Configuring SSH..."
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh

          # SSH í‚¤ ì €ì¥ (ê°œí–‰ ë¬¸ì ë³´ì¡´)
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

          # EC2_HOST ê°’ í™•ì¸ ë° ê²€ì¦
          echo "ğŸ” EC2_HOST ê°’ í™•ì¸: ${EC2_HOST:0:20}..."  # ì²˜ìŒ 20ìë§Œ ì¶œë ¥ (ë³´ì•ˆ)
          if [ -z "$EC2_HOST" ]; then
            echo "âŒ ERROR: EC2_HOST ê°’ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤"
            exit 1
          fi

          # known_hostsì— í˜¸ìŠ¤íŠ¸ ì¶”ê°€
          echo "ğŸ”§ Adding host to known_hosts..."
          ssh-keyscan -H "$EC2_HOST" >> ~/.ssh/known_hosts 2>&1 || {
            echo "âš ï¸  Warning: ssh-keyscan failed, but continuing..."
          }

          # SSH ì—°ê²° í…ŒìŠ¤íŠ¸ (íƒ€ì„ì•„ì›ƒ 5ì´ˆë¡œ ë‹¨ì¶•)
          echo "ğŸ” Testing SSH connection..."
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -o ConnectTimeout=5 -o BatchMode=yes "$EC2_USER@$EC2_HOST" "echo 'SSH connection successful'" || {
            echo "âš ï¸  WARNING: SSH connection test failed (this may be due to security group settings)"
            echo "â„¹ï¸  Continuing anyway - deployment will attempt to connect..."
          }

      - name: Deploy to EC2
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
          DEPLOY_PATH: /opt/langchain
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          echo "Deploying to: $DEPLOY_PATH"
          # OPENAI_API_KEY í™•ì¸ (ë³´ì•ˆì„ ìœ„í•´ ì¼ë¶€ë§Œ ì¶œë ¥)
          if [ -n "$OPENAI_API_KEY" ]; then
            KEY_PREVIEW="${OPENAI_API_KEY:0:10}...${OPENAI_API_KEY: -4}"
            echo "âœ… OPENAI_API_KEY found in secrets (preview: $KEY_PREVIEW)"
          else
            echo "âš ï¸  WARNING: OPENAI_API_KEY not found in GitHub Secrets"
            echo "   The deployment script will check for it in EC2's .env file"
          fi
          chmod +x scripts/deploy_to_ec2.sh
          SSH_KEY_PATH=~/.ssh/deploy_key bash scripts/deploy_to_ec2.sh

      - name: Verify openai folder deployment
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
          DEPLOY_PATH: /opt/langchain
        run: |
          echo "ğŸ” Verifying openai folder deployment..."
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no "$EC2_USER@$EC2_HOST" << ENDSSH
            DEPLOY_PATH="/opt/langchain"
            if [ -d "\$DEPLOY_PATH/openai" ]; then
              echo "âœ… openai folder exists"
              if [ -f "\$DEPLOY_PATH/openai/app/core/llm/openai.py" ]; then
                echo "âœ… openai.py file found"
                if [ -f "\$DEPLOY_PATH/openai/__init__.py" ]; then
                  echo "âœ… openai/__init__.py found"
                  if [ -f "\$DEPLOY_PATH/openai/app/__init__.py" ]; then
                    echo "âœ… openai/app/__init__.py found"
                    if [ -f "\$DEPLOY_PATH/openai/app/core/__init__.py" ]; then
                      echo "âœ… openai/app/core/__init__.py found"
                      if [ -f "\$DEPLOY_PATH/openai/app/core/llm/__init__.py" ]; then
                        echo "âœ… openai/app/core/llm/__init__.py found"
                        echo "âœ… openai folder structure is correct"
                      else
                        echo "âš ï¸  openai/app/core/llm/__init__.py not found"
                      fi
                    else
                      echo "âš ï¸  openai/app/core/__init__.py not found"
                    fi
                  else
                    echo "âš ï¸  openai/app/__init__.py not found"
                  fi
                else
                  echo "âš ï¸  openai/__init__.py not found"
                fi
              else
                echo "âŒ openai.py file not found"
                exit 1
              fi
            else
              echo "âŒ openai folder not found"
              exit 1
            fi
          ENDSSH

      - name: Notify deployment status
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "âœ… Deployment succeeded"
          else
            echo "âŒ Deployment failed"
          fi

      - name: Cleanup SSH key
        if: always()
        run: rm -f ~/.ssh/deploy_key

